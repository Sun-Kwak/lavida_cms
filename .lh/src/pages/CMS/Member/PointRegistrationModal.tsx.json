{
    "sourceFile": "src/pages/CMS/Member/PointRegistrationModal.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1761374511590,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1761374511590,
            "name": "Commit-0",
            "content": "import React, { useState, useEffect } from 'react';\nimport styled from 'styled-components';\nimport { toast } from 'react-toastify';\nimport { AppColors } from '../../../styles/colors';\nimport { AppTextStyles } from '../../../styles/textStyles';\nimport { dbManager } from '../../../utils/indexedDB';\nimport Modal from '../../../components/Modal';\nimport CustomDropdown from '../../../components/CustomDropdown';\n\nconst FormContainer = styled.div`\n  display: flex;\n  flex-direction: column;\n  gap: 24px;\n  padding: 24px;\n  min-height: 300px;\n`;\n\nconst FormGroup = styled.div`\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n`;\n\nconst Label = styled.label`\n  ${AppTextStyles.body1}\n  font-weight: 600;\n  color: ${AppColors.onSurface};\n`;\n\nconst RequiredMark = styled.span`\n  color: ${AppColors.error};\n  margin-left: 4px;\n`;\n\nconst TextInput = styled.input`\n  padding: 12px 16px;\n  border: 1px solid ${AppColors.borderLight};\n  border-radius: 8px;\n  font-size: 14px;\n  \n  &:focus {\n    outline: none;\n    border-color: ${AppColors.primary};\n  }\n  \n  &::placeholder {\n    color: ${AppColors.onInput1};\n  }\n`;\n\nconst AmountInput = styled.input`\n  padding: 12px 16px;\n  border: 1px solid ${AppColors.borderLight};\n  border-radius: 8px;\n  font-size: 16px;\n  font-weight: 600;\n  text-align: right;\n  \n  &:focus {\n    outline: none;\n    border-color: ${AppColors.primary};\n  }\n  \n  &::placeholder {\n    color: ${AppColors.onInput1};\n    font-weight: normal;\n  }\n`;\n\nconst MemberSearchContainer = styled.div`\n  display: flex;\n  gap: 12px;\n  align-items: flex-end;\n`;\n\nconst SearchButton = styled.button`\n  padding: 12px 16px;\n  background: ${AppColors.primary};\n  color: ${AppColors.onPrimary};\n  border: none;\n  border-radius: 8px;\n  font-weight: 600;\n  cursor: pointer;\n  white-space: nowrap;\n  \n  &:hover {\n    opacity: 0.9;\n  }\n  \n  &:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n  }\n`;\n\nconst MemberInfo = styled.div`\n  padding: 16px;\n  background: ${AppColors.background};\n  border: 1px solid ${AppColors.borderLight};\n  border-radius: 8px;\n  font-size: 14px;\n  \n  .member-name {\n    font-weight: 600;\n    font-size: 16px;\n    margin-bottom: 8px;\n  }\n  \n  .member-details {\n    display: flex;\n    flex-direction: column;\n    gap: 4px;\n    color: ${AppColors.onInput1};\n  }\n`;\n\nconst PaymentSummary = styled.div`\n  padding: 16px;\n  background: #e3f2fd;\n  border-radius: 8px;\n  border: 1px solid ${AppColors.primary};\n  \n  .summary-title {\n    font-weight: 600;\n    margin-bottom: 12px;\n    color: ${AppColors.primary};\n  }\n  \n  .summary-item {\n    display: flex;\n    justify-content: space-between;\n    margin-bottom: 8px;\n    \n    &.total {\n      border-top: 1px solid ${AppColors.primary};\n      padding-top: 8px;\n      font-weight: 600;\n      font-size: 16px;\n    }\n  }\n`;\n\nconst ModalButton = styled.button<{ $variant?: 'primary' | 'secondary'; disabled?: boolean }>`\n  flex: 1;\n  padding: 12px 16px;\n  border-radius: 8px;\n  font-size: 14px;\n  font-weight: 500;\n  cursor: pointer;\n  border: none;\n  \n  ${({ $variant, disabled }) => $variant === 'primary' ? `\n    background-color: ${disabled ? '#cccccc' : AppColors.primary};\n    color: ${AppColors.onPrimary};\n    cursor: ${disabled ? 'not-allowed' : 'pointer'};\n    \n    &:hover {\n      background-color: ${disabled ? '#cccccc' : AppColors.secondary};\n    }\n  ` : `\n    background-color: ${AppColors.surface};\n    color: ${AppColors.onSurface};\n    border: 1px solid ${AppColors.borderLight};\n    \n    &:hover {\n      background-color: ${AppColors.background};\n    }\n  `}\n`;\n\nconst CustomModalFooter = styled.div`\n  display: flex;\n  width: 100%;\n  gap: 12px;\n  padding: 0 24px 24px;\n`;\n\nconst BonusInfo = styled.div`\n  padding: 12px;\n  background: #e8f5e8;\n  border: 1px solid ${AppColors.success};\n  border-radius: 8px;\n  font-size: 14px;\n  color: ${AppColors.success};\n  \n  .bonus-title {\n    font-weight: 600;\n    margin-bottom: 4px;\n  }\n`;\n\ninterface PointRegistrationModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onSuccess: () => void;\n}\n\ninterface Member {\n  id: string;\n  name: string;\n  phone: string;\n  email?: string;\n  branchId: string;\n  branchName: string;\n  coach: string;\n  coachName: string;\n}\n\nconst PointRegistrationModal: React.FC<PointRegistrationModalProps> = ({\n  isOpen,\n  onClose,\n  onSuccess\n}) => {\n  const [memberSearchQuery, setMemberSearchQuery] = useState('');\n  const [selectedMember, setSelectedMember] = useState<Member | null>(null);\n  const [paymentMethod, setPaymentMethod] = useState<'cash' | 'card' | 'transfer'>('cash');\n  const [amount, setAmount] = useState<string>('');\n  const [memo, setMemo] = useState('');\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [isSearching, setIsSearching] = useState(false);\n\n  // ëª¨ë‹¬ì´ ë‹«í ë•Œ ìƒíƒœ ì´ˆê¸°í™”\n  useEffect(() => {\n    if (!isOpen) {\n      setMemberSearchQuery('');\n      setSelectedMember(null);\n      setPaymentMethod('cash');\n      setAmount('');\n      setMemo('');\n      setIsProcessing(false);\n      setIsSearching(false);\n    }\n  }, [isOpen]);\n\n  // íšŒì› ê²€ìƒ‰\n  const handleMemberSearch = async () => {\n    if (!memberSearchQuery.trim()) {\n      toast.warning('íšŒì›ëª… ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');\n      return;\n    }\n\n    setIsSearching(true);\n    try {\n      const members = await dbManager.getAllMembers();\n      const foundMember = members.find(member => \n        member.name.includes(memberSearchQuery.trim()) ||\n        member.phone.includes(memberSearchQuery.trim())\n      );\n\n      if (foundMember) {\n        setSelectedMember(foundMember);\n        toast.success(`íšŒì›ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤: ${foundMember.name}`);\n      } else {\n        setSelectedMember(null);\n        toast.error('í•´ë‹¹í•˜ëŠ” íšŒì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');\n      }\n    } catch (error) {\n      console.error('íšŒì› ê²€ìƒ‰ ì‹¤íŒ¨:', error);\n      toast.error('íšŒì› ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');\n    } finally {\n      setIsSearching(false);\n    }\n  };\n\n  // ê¸ˆì•¡ í¬ë§·íŒ…\n  const formatAmount = (value: string) => {\n    const numericValue = value.replace(/[^\\d]/g, '');\n    return numericValue ? parseInt(numericValue).toLocaleString() : '';\n  };\n\n  // ê¸ˆì•¡ ì…ë ¥ ì²˜ë¦¬\n  const handleAmountChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const value = e.target.value.replace(/[^\\d]/g, '');\n    setAmount(value);\n  };\n\n  // ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ ê³„ì‚°\n  const calculateBonus = (baseAmount: number) => {\n    if (baseAmount >= 1000000) {\n      const millionUnits = Math.floor(baseAmount / 1000000);\n      return millionUnits * 100000; // 100ë§Œì›ë‹¹ 10ë§Œì›(10%) ë³´ë„ˆìŠ¤\n    }\n    return 0;\n  };\n\n  // ì ë¦½ê¸ˆ ë“±ë¡ ì²˜ë¦¬\n  const handleSubmit = async () => {\n    if (!selectedMember) {\n      toast.error('íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');\n      return;\n    }\n\n    if (!amount || parseInt(amount) <= 0) {\n      toast.error('ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');\n      return;\n    }\n\n    const baseAmount = parseInt(amount);\n    const bonusAmount = calculateBonus(baseAmount);\n    const totalAmount = baseAmount + bonusAmount;\n\n    setIsProcessing(true);\n    try {\n      // 1. ê²°ì œ ì •ë³´ ê¸°ë¡ ìƒì„±\n      const paymentId = await dbManager.addPayment({\n        memberId: selectedMember.id,\n        memberName: selectedMember.name,\n        branchId: selectedMember.branchId,\n        branchName: selectedMember.branchName,\n        coach: selectedMember.coach,\n        coachName: selectedMember.coachName,\n        products: [], // ìƒí’ˆ ì—†ìŒ\n        totalAmount: baseAmount,\n        paidAmount: baseAmount,\n        unpaidAmount: 0,\n        paymentStatus: 'completed',\n        paymentMethod: paymentMethod,\n        paymentDate: new Date(),\n        paymentType: 'other',\n        amount: baseAmount,\n        memo: memo || `ì ë¦½ê¸ˆ ë“±ë¡ - ${paymentMethod} ${baseAmount.toLocaleString()}ì›`\n      });\n\n      // 2. ê¸°ë³¸ í¬ì¸íŠ¸ ì ë¦½\n      const expiryDate = new Date();\n      expiryDate.setFullYear(expiryDate.getFullYear() + 1);\n\n      await dbManager.point.addPointTransaction({\n        memberId: selectedMember.id,\n        memberName: selectedMember.name,\n        amount: baseAmount,\n        transactionType: 'earn',\n        relatedOrderId: undefined,\n        relatedPaymentId: paymentId,\n        products: [],\n        branchId: selectedMember.branchId,\n        branchName: selectedMember.branchName,\n        staffId: selectedMember.coach,\n        staffName: selectedMember.coachName,\n        earnedDate: new Date(),\n        expiryDate,\n        isExpired: false,\n        source: 'ì ë¦½ê¸ˆ ë“±ë¡',\n        description: `ì ë¦½ê¸ˆ ë“±ë¡ - ${paymentMethod} ${baseAmount.toLocaleString()}ì›${memo ? ` (${memo})` : ''}`\n      });\n\n      // 3. ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ ì ë¦½ (100ë§Œì› ì´ìƒì¸ ê²½ìš°)\n      if (bonusAmount > 0) {\n        await dbManager.point.addPointTransaction({\n          memberId: selectedMember.id,\n          memberName: selectedMember.name,\n          amount: bonusAmount,\n          transactionType: 'earn',\n          relatedOrderId: undefined,\n          relatedPaymentId: paymentId,\n          products: [],\n          branchId: selectedMember.branchId,\n          branchName: selectedMember.branchName,\n          staffId: selectedMember.coach,\n          staffName: selectedMember.coachName,\n          earnedDate: new Date(),\n          expiryDate,\n          isExpired: false,\n          source: 'ë³´ë„ˆìŠ¤í¬ì¸íŠ¸',\n          description: `ì ë¦½ê¸ˆ ë“±ë¡ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ (${baseAmount.toLocaleString()}ì› â†’ ${Math.floor(baseAmount / 1000000)}ê°œ 100ë§Œì› ë‹¨ìœ„)`\n        });\n      }\n\n      const successMessage = bonusAmount > 0 \n        ? `ì ë¦½ê¸ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!\\nê¸°ë³¸ ì ë¦½: ${baseAmount.toLocaleString()}ì›\\në³´ë„ˆìŠ¤ ì ë¦½: ${bonusAmount.toLocaleString()}ì›\\nì´ ì ë¦½: ${totalAmount.toLocaleString()}ì›`\n        : `ì ë¦½ê¸ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!\\nì´ ì ë¦½: ${baseAmount.toLocaleString()}ì›`;\n\n      toast.success(successMessage);\n      onSuccess();\n      onClose();\n    } catch (error) {\n      console.error('ì ë¦½ê¸ˆ ë“±ë¡ ì‹¤íŒ¨:', error);\n      toast.error('ì ë¦½ê¸ˆ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  const paymentMethodOptions = [\n    { value: 'cash', label: 'í˜„ê¸ˆ' },\n    { value: 'card', label: 'ì¹´ë“œ' },\n    { value: 'transfer', label: 'ê³„ì¢Œì´ì²´' }\n  ];\n\n  const baseAmount = amount ? parseInt(amount) : 0;\n  const bonusAmount = calculateBonus(baseAmount);\n  const totalAmount = baseAmount + bonusAmount;\n  const isValid = selectedMember && baseAmount > 0;\n\n  return (\n    <Modal\n      isOpen={isOpen}\n      onClose={onClose}\n      header=\"ì ë¦½ê¸ˆ ë“±ë¡\"\n      width=\"600px\"\n      body={\n        <FormContainer>\n          {/* íšŒì› ê²€ìƒ‰ */}\n          <FormGroup>\n            <Label>\n              íšŒì› ê²€ìƒ‰<RequiredMark>*</RequiredMark>\n            </Label>\n            <MemberSearchContainer>\n              <TextInput\n                value={memberSearchQuery}\n                onChange={(e: React.ChangeEvent<HTMLInputElement>) => setMemberSearchQuery(e.target.value)}\n                placeholder=\"íšŒì›ëª… ë˜ëŠ” ì „í™”ë²ˆí˜¸ ì…ë ¥\"\n                onKeyPress={(e: React.KeyboardEvent<HTMLInputElement>) => {\n                  if (e.key === 'Enter') {\n                    handleMemberSearch();\n                  }\n                }}\n              />\n              <SearchButton\n                onClick={handleMemberSearch}\n                disabled={isSearching || !memberSearchQuery.trim()}\n              >\n                {isSearching ? 'ê²€ìƒ‰ ì¤‘...' : 'ê²€ìƒ‰'}\n              </SearchButton>\n            </MemberSearchContainer>\n          </FormGroup>\n\n          {/* ì„ íƒëœ íšŒì› ì •ë³´ */}\n          {selectedMember && (\n            <FormGroup>\n              <Label>ì„ íƒëœ íšŒì›</Label>\n              <MemberInfo>\n                <div className=\"member-name\">{selectedMember.name}</div>\n                <div className=\"member-details\">\n                  <div>ì „í™”ë²ˆí˜¸: {selectedMember.phone}</div>\n                  <div>ì´ë©”ì¼: {selectedMember.email || '-'}</div>\n                  <div>ì§€ì : {selectedMember.branchName}</div>\n                  <div>ë‹´ë‹¹ì½”ì¹˜: {selectedMember.coachName}</div>\n                </div>\n              </MemberInfo>\n            </FormGroup>\n          )}\n\n          {/* ê²°ì œ ë°©ì‹ */}\n          <FormGroup>\n            <Label>\n              ê²°ì œ ë°©ì‹<RequiredMark>*</RequiredMark>\n            </Label>\n            <CustomDropdown\n              value={paymentMethod}\n              onChange={(value) => setPaymentMethod(value as 'cash' | 'card' | 'transfer')}\n              options={paymentMethodOptions}\n              placeholder=\"ê²°ì œ ë°©ì‹ ì„ íƒ\"\n            />\n          </FormGroup>\n\n          {/* ê¸ˆì•¡ */}\n          <FormGroup>\n            <Label>\n              ê¸ˆì•¡<RequiredMark>*</RequiredMark>\n            </Label>\n            <AmountInput\n              type=\"text\"\n              value={formatAmount(amount)}\n              onChange={handleAmountChange}\n              placeholder=\"ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”\"\n            />\n          </FormGroup>\n\n          {/* ë©”ëª¨ */}\n          <FormGroup>\n            <Label>ë©”ëª¨</Label>\n            <TextInput\n              value={memo}\n              onChange={(e: React.ChangeEvent<HTMLInputElement>) => setMemo(e.target.value)}\n              placeholder=\"ì¶”ê°€ ë©”ëª¨ (ì„ íƒì‚¬í•­)\"\n            />\n          </FormGroup>\n\n          {/* 100ë§Œì› ì´ìƒì¼ ë•Œ ë³´ë„ˆìŠ¤ ì •ë³´ í‘œì‹œ */}\n          {bonusAmount > 0 && (\n            <BonusInfo>\n              <div className=\"bonus-title\">ğŸ‰ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ ì ìš©!</div>\n              <div>100ë§Œì› ë‹¨ìœ„ë§ˆë‹¤ 10% ì¶”ê°€ ì ë¦½ë©ë‹ˆë‹¤.</div>\n            </BonusInfo>\n          )}\n\n          {/* ì ë¦½ ìš”ì•½ */}\n          {baseAmount > 0 && (\n            <PaymentSummary>\n              <div className=\"summary-title\">ì ë¦½ ìš”ì•½</div>\n              <div className=\"summary-item\">\n                <span>ê¸°ë³¸ ì ë¦½</span>\n                <span>{baseAmount.toLocaleString()}ì›</span>\n              </div>\n              {bonusAmount > 0 && (\n                <div className=\"summary-item\">\n                  <span>ë³´ë„ˆìŠ¤ ì ë¦½ ({Math.floor(baseAmount / 1000000)}ê°œ 100ë§Œì› ë‹¨ìœ„)</span>\n                  <span>{bonusAmount.toLocaleString()}ì›</span>\n                </div>\n              )}\n              <div className=\"summary-item total\">\n                <span>ì´ ì ë¦½ í¬ì¸íŠ¸</span>\n                <span>{totalAmount.toLocaleString()}ì›</span>\n              </div>\n            </PaymentSummary>\n          )}\n        </FormContainer>\n      }\n      footer={\n        <CustomModalFooter>\n          <ModalButton onClick={onClose}>\n            ì·¨ì†Œ\n          </ModalButton>\n          <ModalButton \n            $variant=\"primary\" \n            disabled={!isValid || isProcessing}\n            onClick={handleSubmit}\n          >\n            {isProcessing ? 'ë“±ë¡ ì¤‘...' : 'ì ë¦½ê¸ˆ ë“±ë¡'}\n          </ModalButton>\n        </CustomModalFooter>\n      }\n    />\n  );\n};\n\nexport default PointRegistrationModal;"
        }
    ]
}