{
    "sourceFile": "src/pages/CMS/Member/CourseRegistrationModal.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 8,
            "patches": [
                {
                    "date": 1761132526034,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1761132724778,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,24 +12,31 @@\n   display: flex;\n   gap: 24px;\n   height: 600px;\n   min-width: 900px;\n+  width: 100%;\n+  overflow: hidden;\n `;\n \n const LeftPanel = styled.div`\n   flex: 1;\n   border-right: 1px solid ${AppColors.borderLight};\n   padding-right: 24px;\n+  min-width: 0; /* í”Œë ‰ìŠ¤ ì•„ì´í…œì´ ì¶•ì†Œë  ìˆ˜ ìˆë„ë¡ */\n+  display: flex;\n+  flex-direction: column;\n `;\n \n const RightPanel = styled.div`\n   flex: 1;\n   padding-left: 24px;\n+  min-width: 0; /* í”Œë ‰ìŠ¤ ì•„ì´í…œì´ ì¶•ì†Œë  ìˆ˜ ìˆë„ë¡ */\n+  display: flex;\n+  flex-direction: column;\n `;\n \n const PanelTitle = styled.h3`\n-  font-size: ${AppTextStyles.title3.fontSize};\n-  font-weight: 700;\n+  ${AppTextStyles.title3}\n   margin-bottom: 16px;\n   color: ${AppColors.onBackground};\n   border-bottom: 2px solid ${AppColors.primary};\n   padding-bottom: 8px;\n"
                },
                {
                    "date": 1761132784677,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -69,10 +69,8 @@\n   display: flex;\n   justify-content: flex-end;\n   gap: 12px;\n   margin-top: 24px;\n-  padding-top: 24px;\n-  border-top: 1px solid ${AppColors.borderLight};\n `;\n \n const WarningText = styled.div`\n   background: #fff3cd;\n"
                },
                {
                    "date": 1761133874406,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -151,17 +151,28 @@\n \n     try {\n       const totalAmount = paymentInfo.selectedProducts.reduce((sum, product) => sum + product.price, 0);\n       const pointPayment = paymentInfo.pointPayment || 0;\n-      const cashPayment = (paymentInfo.receivedAmount || 0) - pointPayment;\n-      const unpaidAmount = Math.max(0, totalAmount - pointPayment - cashPayment);\n+      const cashPayment = paymentInfo.receivedAmount || 0; // í˜„ê¸ˆ/ì¹´ë“œë¡œ ë°›ì€ ê¸ˆì•¡\n+      const totalReceived = pointPayment + cashPayment; // ì´ ë°›ì€ ê¸ˆì•¡\n+      const unpaidAmount = Math.max(0, totalAmount - totalReceived);\n \n       // í¬ì¸íŠ¸ ê²°ì œê°€ ì”ì•¡ì„ ì´ˆê³¼í•˜ëŠ”ì§€ í™•ì¸\n       if (pointPayment > memberPointBalance) {\n         toast.error(`í¬ì¸íŠ¸ ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (ì”ì•¡: ${memberPointBalance.toLocaleString()}ì›)`);\n         return;\n       }\n \n+      // ì´ ë°›ì€ ê¸ˆì•¡ì´ ì´ ê²°ì œ ê¸ˆì•¡ì„ ì´ˆê³¼í•˜ëŠ”ì§€ í™•ì¸\n+      if (totalReceived > totalAmount) {\n+        const excessAmount = totalReceived - totalAmount;\n+        const confirmed = window.confirm(\n+          `ì´ ë°›ì€ ê¸ˆì•¡ì´ ê²°ì œ ê¸ˆì•¡ë³´ë‹¤ ${excessAmount.toLocaleString()}ì› ë§ìŠµë‹ˆë‹¤.\\n` +\n+          `ì´ˆê³¼ ê¸ˆì•¡ì€ í¬ì¸íŠ¸ë¡œ ì ë¦½ë©ë‹ˆë‹¤. ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`\n+        );\n+        if (!confirmed) return;\n+      }\n+\n       // ê° ìƒí’ˆë³„ë¡œ ìˆ˜ê°• ë“±ë¡ ë° ê²°ì œ ì²˜ë¦¬\n       for (const product of paymentInfo.selectedProducts) {\n         // 1. ìƒí’ˆ ì •ë³´ ì¡°íšŒ (í”„ë¡œê·¸ë¨ ì •ë³´ í¬í•¨)\n         const dbProduct = await dbManager.getProductById(product.id);\n@@ -183,10 +194,10 @@\n           branchName: selectedMember.branchName,\n           coach: selectedMember.coach,\n           coachName: selectedMember.coachName,\n           enrollmentStatus: unpaidAmount > 0 ? 'unpaid' as const : 'completed' as const,\n-          paidAmount: Math.min(product.price, pointPayment + cashPayment),\n-          unpaidAmount: Math.max(0, product.price - pointPayment - cashPayment),\n+          paidAmount: Math.min(product.price, totalReceived),\n+          unpaidAmount: Math.max(0, product.price - totalReceived),\n           startDate: new Date(),\n           endDate: dbProduct.programType === 'ê¸°ê°„ì œ' ? (() => {\n             const endDate = new Date();\n             endDate.setMonth(endDate.getMonth() + 3); // ê¸°ë³¸ 3ê°œì›”\n@@ -199,42 +210,78 @@\n \n         // 3. ìˆ˜ê°• ë“±ë¡ ì €ì¥\n         const courseId = await dbManager.addCourseEnrollment(courseData);\n \n-        // 4. ê²°ì œ ë°ì´í„° ìƒì„±\n-        const paymentData = {\n-          memberId: selectedMember.id,\n-          memberName: selectedMember.name,\n-          branchId: selectedMember.branchId,\n-          branchName: selectedMember.branchName,\n-          coach: selectedMember.coach,\n-          coachName: selectedMember.coachName,\n-          paymentMethod: paymentInfo.paymentMethod,\n-          paymentStatus: unpaidAmount > 0 ? 'unpaid' as const : 'completed' as const,\n-          totalAmount: product.price,\n-          paidAmount: Math.min(product.price, pointPayment + cashPayment),\n-          unpaidAmount: Math.max(0, product.price - pointPayment - cashPayment),\n-          paymentDate: new Date(),\n-          paymentType: 'course' as const,\n-          relatedCourseId: courseId,\n-          relatedAssetId: null,\n-          products: [{\n-            id: product.id,\n-            name: product.name,\n-            price: product.price,\n-            quantity: 1,\n-            programId: dbProduct.programId,\n-            programName: dbProduct.programName,\n-            programType: dbProduct.programType\n-          }],\n-          memo: `ìƒˆ ìˆ˜ê°• ë“±ë¡ - ${product.name} (ìˆ˜ê°• ID: ${courseId})`\n-        };\n+        // 4. ê²°ì œ ë°ì´í„° ìƒì„± - í˜„ê¸ˆ/ì¹´ë“œ ê²°ì œê°€ ìˆëŠ” ê²½ìš°ë§Œ\n+        if (cashPayment > 0) {\n+          const paymentData = {\n+            memberId: selectedMember.id,\n+            memberName: selectedMember.name,\n+            branchId: selectedMember.branchId,\n+            branchName: selectedMember.branchName,\n+            coach: selectedMember.coach,\n+            coachName: selectedMember.coachName,\n+            paymentMethod: paymentInfo.paymentMethod, // í˜„ê¸ˆ/ì¹´ë“œ ê²°ì œ ë°©ë²•\n+            paymentStatus: unpaidAmount > 0 ? 'unpaid' as const : 'completed' as const,\n+            totalAmount: cashPayment, // í˜„ê¸ˆ/ì¹´ë“œë¡œ ë°›ì€ ê¸ˆì•¡\n+            paidAmount: cashPayment,\n+            unpaidAmount: 0, // í˜„ê¸ˆ/ì¹´ë“œ ê²°ì œëŠ” ë°›ì€ ë§Œí¼ ì™„ë‚©\n+            paymentDate: new Date(),\n+            paymentType: 'course' as const,\n+            relatedCourseId: courseId,\n+            relatedAssetId: null,\n+            products: [{\n+              id: product.id,\n+              name: product.name,\n+              price: cashPayment, // í˜„ê¸ˆ/ì¹´ë“œë¡œ ê²°ì œëœ ë¶€ë¶„\n+              quantity: 1,\n+              programId: dbProduct.programId,\n+              programName: dbProduct.programName,\n+              programType: dbProduct.programType\n+            }],\n+            memo: `ìƒˆ ìˆ˜ê°• ë“±ë¡ - ${product.name} (í˜„ê¸ˆ/ì¹´ë“œ ê²°ì œ: ${cashPayment.toLocaleString()}ì›)`\n+          };\n \n-        // 5. ê²°ì œ ì •ë³´ ì €ì¥\n-        await dbManager.addPayment(paymentData);\n+          // 5. í˜„ê¸ˆ/ì¹´ë“œ ê²°ì œ ì •ë³´ ì €ì¥\n+          await dbManager.addPayment(paymentData);\n+        }\n+\n+        // 6. í¬ì¸íŠ¸ ê²°ì œ ë°ì´í„° ìƒì„± - í¬ì¸íŠ¸ ê²°ì œê°€ ìˆëŠ” ê²½ìš°ë§Œ\n+        if (pointPayment > 0) {\n+          const pointPaymentData = {\n+            memberId: selectedMember.id,\n+            memberName: selectedMember.name,\n+            branchId: selectedMember.branchId,\n+            branchName: selectedMember.branchName,\n+            coach: selectedMember.coach,\n+            coachName: selectedMember.coachName,\n+            paymentMethod: 'point', // í¬ì¸íŠ¸ ê²°ì œ\n+            paymentStatus: 'completed' as const, // í¬ì¸íŠ¸ëŠ” ì¦‰ì‹œ ì™„ë£Œ\n+            totalAmount: pointPayment, // í¬ì¸íŠ¸ë¡œ ê²°ì œëœ ê¸ˆì•¡\n+            paidAmount: pointPayment,\n+            unpaidAmount: 0, // í¬ì¸íŠ¸ ê²°ì œëŠ” ì¦‰ì‹œ ì™„ë‚©\n+            paymentDate: new Date(),\n+            paymentType: 'course' as const,\n+            relatedCourseId: courseId,\n+            relatedAssetId: null,\n+            products: [{\n+              id: product.id,\n+              name: product.name,\n+              price: pointPayment, // í¬ì¸íŠ¸ë¡œ ê²°ì œëœ ë¶€ë¶„\n+              quantity: 1,\n+              programId: dbProduct.programId,\n+              programName: dbProduct.programName,\n+              programType: dbProduct.programType\n+            }],\n+            memo: `ìƒˆ ìˆ˜ê°• ë“±ë¡ - ${product.name} (í¬ì¸íŠ¸ ê²°ì œ: ${pointPayment.toLocaleString()}ì›)`\n+          };\n+\n+          // 7. í¬ì¸íŠ¸ ê²°ì œ ì •ë³´ ì €ì¥\n+          await dbManager.addPayment(pointPaymentData);\n+        }\n       }\n \n-      // 6. í¬ì¸íŠ¸ ì‚¬ìš© ì²˜ë¦¬\n+      // 8. í¬ì¸íŠ¸ ì‚¬ìš© ì²˜ë¦¬\n       if (pointPayment > 0) {\n         await dbManager.addPoint({\n           memberId: selectedMember.id,\n           memberName: selectedMember.name,\n@@ -244,11 +291,11 @@\n           description: `ìˆ˜ê°•ë“±ë¡ í¬ì¸íŠ¸ ê²°ì œ (${paymentInfo.selectedProducts.map(p => p.name).join(', ')})`\n         });\n       }\n \n-      // 7. ì´ˆê³¼ ê¸ˆì•¡ í¬ì¸íŠ¸ ì ë¦½ ì²˜ë¦¬\n-      if (cashPayment > totalAmount - pointPayment) {\n-        const excessAmount = cashPayment - (totalAmount - pointPayment);\n+      // 9. ì´ˆê³¼ ê¸ˆì•¡ í¬ì¸íŠ¸ ì ë¦½ ì²˜ë¦¬ (í˜„ê¸ˆ/ì¹´ë“œ ì´ˆê³¼ë¶„ë§Œ)\n+      if (totalReceived > totalAmount) {\n+        const excessAmount = totalReceived - totalAmount;\n         await dbManager.addPoint({\n           memberId: selectedMember.id,\n           memberName: selectedMember.name,\n           amount: excessAmount,\n"
                },
                {
                    "date": 1761366312724,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -134,9 +134,9 @@\n   const handlePaymentUpdate = (updates: Partial<PaymentInfo>) => {\n     setPaymentInfo(prev => ({ ...prev, ...updates }));\n   };\n \n-  // ìˆ˜ê°• ë“±ë¡ ì²˜ë¦¬\n+  // ìˆ˜ê°• ë“±ë¡ ì²˜ë¦¬ - ê°œì„ ëœ í†µí•© ì£¼ë¬¸ ë°©ì‹\n   const handleRegisterCourse = async () => {\n     if (!selectedMember) {\n       toast.error('íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');\n       return;\n@@ -153,9 +153,8 @@\n       const totalAmount = paymentInfo.selectedProducts.reduce((sum, product) => sum + product.price, 0);\n       const pointPayment = paymentInfo.pointPayment || 0;\n       const cashPayment = paymentInfo.receivedAmount || 0; // í˜„ê¸ˆ/ì¹´ë“œë¡œ ë°›ì€ ê¸ˆì•¡\n       const totalReceived = pointPayment + cashPayment; // ì´ ë°›ì€ ê¸ˆì•¡\n-      const unpaidAmount = Math.max(0, totalAmount - totalReceived);\n \n       // í¬ì¸íŠ¸ ê²°ì œê°€ ì”ì•¡ì„ ì´ˆê³¼í•˜ëŠ”ì§€ í™•ì¸\n       if (pointPayment > memberPointBalance) {\n         toast.error(`í¬ì¸íŠ¸ ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (ì”ì•¡: ${memberPointBalance.toLocaleString()}ì›)`);\n@@ -171,144 +170,51 @@\n         );\n         if (!confirmed) return;\n       }\n \n-      // ê° ìƒí’ˆë³„ë¡œ ìˆ˜ê°• ë“±ë¡ ë° ê²°ì œ ì²˜ë¦¬\n+      // ìƒí’ˆ ì •ë³´ ì¡°íšŒ ë° ì¤€ë¹„\n+      const orderProducts = [];\n       for (const product of paymentInfo.selectedProducts) {\n-        // 1. ìƒí’ˆ ì •ë³´ ì¡°íšŒ (í”„ë¡œê·¸ë¨ ì •ë³´ í¬í•¨)\n         const dbProduct = await dbManager.getProductById(product.id);\n         if (!dbProduct) {\n           throw new Error(`ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${product.name}`);\n         }\n-\n-        // 2. ìˆ˜ê°• ë“±ë¡ ë°ì´í„° ìƒì„±\n-        const courseData = {\n-          memberId: selectedMember.id,\n-          memberName: selectedMember.name,\n-          productId: product.id,\n-          productName: product.name,\n-          productPrice: product.price,\n+        \n+        orderProducts.push({\n+          id: product.id,\n+          name: product.name,\n+          price: product.price,\n           programId: dbProduct.programId,\n           programName: dbProduct.programName,\n-          programType: dbProduct.programType,\n+          programType: dbProduct.programType\n+        });\n+      }\n+\n+      // í†µí•© ì£¼ë¬¸ ì²˜ë¦¬ ì‹¤í–‰\n+      const orderId = await dbManager.processOrderWithPayments({\n+        memberInfo: {\n+          id: selectedMember.id,\n+          name: selectedMember.name,\n           branchId: selectedMember.branchId,\n           branchName: selectedMember.branchName,\n           coach: selectedMember.coach,\n-          coachName: selectedMember.coachName,\n-          enrollmentStatus: unpaidAmount > 0 ? 'unpaid' as const : 'completed' as const,\n-          paidAmount: Math.min(product.price, totalReceived),\n-          unpaidAmount: Math.max(0, product.price - totalReceived),\n-          startDate: new Date(),\n-          endDate: dbProduct.programType === 'ê¸°ê°„ì œ' ? (() => {\n-            const endDate = new Date();\n-            endDate.setMonth(endDate.getMonth() + 3); // ê¸°ë³¸ 3ê°œì›”\n-            return endDate;\n-          })() : undefined,\n-          sessionCount: dbProduct.sessions || undefined,\n-          completedSessions: 0,\n-          notes: 'ìƒˆ ìˆ˜ê°• ë“±ë¡ì„ í†µí•´ ë“±ë¡ë¨'\n-        };\n+          coachName: selectedMember.coachName\n+        },\n+        products: orderProducts,\n+        payments: {\n+          cash: paymentInfo.paymentMethod === 'cash' ? cashPayment : 0,\n+          card: paymentInfo.paymentMethod === 'card' ? cashPayment : 0,\n+          transfer: paymentInfo.paymentMethod === 'transfer' ? cashPayment : 0,\n+          points: pointPayment\n+        },\n+        orderType: 'course_enrollment'\n+      });\n \n-        // 3. ìˆ˜ê°• ë“±ë¡ ì €ì¥\n-        const courseId = await dbManager.addCourseEnrollment(courseData);\n-\n-        // 4. ê²°ì œ ë°ì´í„° ìƒì„± - í˜„ê¸ˆ/ì¹´ë“œ ê²°ì œê°€ ìˆëŠ” ê²½ìš°ë§Œ\n-        if (cashPayment > 0) {\n-          const paymentData = {\n-            memberId: selectedMember.id,\n-            memberName: selectedMember.name,\n-            branchId: selectedMember.branchId,\n-            branchName: selectedMember.branchName,\n-            coach: selectedMember.coach,\n-            coachName: selectedMember.coachName,\n-            paymentMethod: paymentInfo.paymentMethod, // í˜„ê¸ˆ/ì¹´ë“œ ê²°ì œ ë°©ë²•\n-            paymentStatus: unpaidAmount > 0 ? 'unpaid' as const : 'completed' as const,\n-            totalAmount: cashPayment, // í˜„ê¸ˆ/ì¹´ë“œë¡œ ë°›ì€ ê¸ˆì•¡\n-            paidAmount: cashPayment,\n-            unpaidAmount: 0, // í˜„ê¸ˆ/ì¹´ë“œ ê²°ì œëŠ” ë°›ì€ ë§Œí¼ ì™„ë‚©\n-            paymentDate: new Date(),\n-            paymentType: 'course' as const,\n-            relatedCourseId: courseId,\n-            relatedAssetId: null,\n-            products: [{\n-              id: product.id,\n-              name: product.name,\n-              price: cashPayment, // í˜„ê¸ˆ/ì¹´ë“œë¡œ ê²°ì œëœ ë¶€ë¶„\n-              quantity: 1,\n-              programId: dbProduct.programId,\n-              programName: dbProduct.programName,\n-              programType: dbProduct.programType\n-            }],\n-            memo: `ìƒˆ ìˆ˜ê°• ë“±ë¡ - ${product.name} (í˜„ê¸ˆ/ì¹´ë“œ ê²°ì œ: ${cashPayment.toLocaleString()}ì›)`\n-          };\n-\n-          // 5. í˜„ê¸ˆ/ì¹´ë“œ ê²°ì œ ì •ë³´ ì €ì¥\n-          await dbManager.addPayment(paymentData);\n-        }\n-\n-        // 6. í¬ì¸íŠ¸ ê²°ì œ ë°ì´í„° ìƒì„± - í¬ì¸íŠ¸ ê²°ì œê°€ ìˆëŠ” ê²½ìš°ë§Œ\n-        if (pointPayment > 0) {\n-          const pointPaymentData = {\n-            memberId: selectedMember.id,\n-            memberName: selectedMember.name,\n-            branchId: selectedMember.branchId,\n-            branchName: selectedMember.branchName,\n-            coach: selectedMember.coach,\n-            coachName: selectedMember.coachName,\n-            paymentMethod: 'point', // í¬ì¸íŠ¸ ê²°ì œ\n-            paymentStatus: 'completed' as const, // í¬ì¸íŠ¸ëŠ” ì¦‰ì‹œ ì™„ë£Œ\n-            totalAmount: pointPayment, // í¬ì¸íŠ¸ë¡œ ê²°ì œëœ ê¸ˆì•¡\n-            paidAmount: pointPayment,\n-            unpaidAmount: 0, // í¬ì¸íŠ¸ ê²°ì œëŠ” ì¦‰ì‹œ ì™„ë‚©\n-            paymentDate: new Date(),\n-            paymentType: 'course' as const,\n-            relatedCourseId: courseId,\n-            relatedAssetId: null,\n-            products: [{\n-              id: product.id,\n-              name: product.name,\n-              price: pointPayment, // í¬ì¸íŠ¸ë¡œ ê²°ì œëœ ë¶€ë¶„\n-              quantity: 1,\n-              programId: dbProduct.programId,\n-              programName: dbProduct.programName,\n-              programType: dbProduct.programType\n-            }],\n-            memo: `ìƒˆ ìˆ˜ê°• ë“±ë¡ - ${product.name} (í¬ì¸íŠ¸ ê²°ì œ: ${pointPayment.toLocaleString()}ì›)`\n-          };\n-\n-          // 7. í¬ì¸íŠ¸ ê²°ì œ ì •ë³´ ì €ì¥\n-          await dbManager.addPayment(pointPaymentData);\n-        }\n-      }\n-\n-      // 8. í¬ì¸íŠ¸ ì‚¬ìš© ì²˜ë¦¬\n-      if (pointPayment > 0) {\n-        await dbManager.addPoint({\n-          memberId: selectedMember.id,\n-          memberName: selectedMember.name,\n-          amount: -pointPayment, // ìŒìˆ˜ë¡œ ì €ì¥ (ì‚¬ìš©)\n-          type: 'used',\n-          source: 'ìˆ˜ê°•ë“±ë¡ í¬ì¸íŠ¸ê²°ì œ',\n-          description: `ìˆ˜ê°•ë“±ë¡ í¬ì¸íŠ¸ ê²°ì œ (${paymentInfo.selectedProducts.map(p => p.name).join(', ')})`\n-        });\n-      }\n-\n-      // 9. ì´ˆê³¼ ê¸ˆì•¡ í¬ì¸íŠ¸ ì ë¦½ ì²˜ë¦¬ (í˜„ê¸ˆ/ì¹´ë“œ ì´ˆê³¼ë¶„ë§Œ)\n-      if (totalReceived > totalAmount) {\n-        const excessAmount = totalReceived - totalAmount;\n-        await dbManager.addPoint({\n-          memberId: selectedMember.id,\n-          memberName: selectedMember.name,\n-          amount: excessAmount,\n-          type: 'earned',\n-          source: 'ìˆ˜ê°•ë“±ë¡ ì´ˆê³¼ê¸ˆì•¡',\n-          description: `ìˆ˜ê°•ë“±ë¡ ì´ˆê³¼ê¸ˆì•¡ í¬ì¸íŠ¸ ì ë¦½ (${excessAmount.toLocaleString()}ì›)`\n-        });\n-      }\n-\n-      toast.success('ìˆ˜ê°• ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');\n+      console.log(`ìˆ˜ê°• ë“±ë¡ í†µí•© ì£¼ë¬¸ ì²˜ë¦¬ ì™„ë£Œ - ì£¼ë¬¸ ID: ${orderId}`);\n+      toast.success(`ìˆ˜ê°• ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ì£¼ë¬¸ ID: ${orderId.slice(-8)})`);\n       onSuccess();\n       onClose();\n+\n     } catch (error) {\n       console.error('ìˆ˜ê°• ë“±ë¡ ì‹¤íŒ¨:', error);\n       toast.error('ìˆ˜ê°• ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');\n     } finally {\n"
                },
                {
                    "date": 1761373763923,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -163,12 +163,22 @@\n \n       // ì´ ë°›ì€ ê¸ˆì•¡ì´ ì´ ê²°ì œ ê¸ˆì•¡ì„ ì´ˆê³¼í•˜ëŠ”ì§€ í™•ì¸\n       if (totalReceived > totalAmount) {\n         const excessAmount = totalReceived - totalAmount;\n-        const confirmed = window.confirm(\n-          `ì´ ë°›ì€ ê¸ˆì•¡ì´ ê²°ì œ ê¸ˆì•¡ë³´ë‹¤ ${excessAmount.toLocaleString()}ì› ë§ìŠµë‹ˆë‹¤.\\n` +\n-          `ì´ˆê³¼ ê¸ˆì•¡ì€ í¬ì¸íŠ¸ë¡œ ì ë¦½ë©ë‹ˆë‹¤. ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`\n-        );\n+        \n+        // ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ ê³„ì‚°\n+        let confirmMessage = `ì´ ë°›ì€ ê¸ˆì•¡ì´ ê²°ì œ ê¸ˆì•¡ë³´ë‹¤ ${excessAmount.toLocaleString()}ì› ë§ìŠµë‹ˆë‹¤.\\nì´ˆê³¼ ê¸ˆì•¡ì€ í¬ì¸íŠ¸ë¡œ ì ë¦½ë©ë‹ˆë‹¤.`;\n+        \n+        if (excessAmount >= 1000000) {\n+          const millionUnits = Math.floor(excessAmount / 1000000);\n+          const bonusPoints = millionUnits * 100000;\n+          confirmMessage += `\\n\\nğŸ ë³´ë„ˆìŠ¤ í˜œíƒ: ì¶”ê°€ ${bonusPoints.toLocaleString()}ì› ë” ì ë¦½ë©ë‹ˆë‹¤!`;\n+          confirmMessage += `\\n(${millionUnits}ê°œ 100ë§Œì› ë‹¨ìœ„ Ã— 10ë§Œì› ë³´ë„ˆìŠ¤)`;\n+        }\n+        \n+        confirmMessage += `\\n\\nê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;\n+        \n+        const confirmed = window.confirm(confirmMessage);\n         if (!confirmed) return;\n       }\n \n       // ìƒí’ˆ ì •ë³´ ì¡°íšŒ ë° ì¤€ë¹„\n"
                },
                {
                    "date": 1761375753678,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-import React, { useState } from 'react';\n+import React, { useState, useEffect } from 'react';\n import styled from 'styled-components';\n import { toast } from 'react-toastify';\n import Modal from '../../../components/Modal';\n import { dbManager, type Member } from '../../../utils/indexedDB';\n@@ -100,14 +100,16 @@\n interface CourseRegistrationModalProps {\n   isOpen: boolean;\n   onClose: () => void;\n   onSuccess: () => void;\n+  preselectedMember?: Member | null; // ë¯¸ë¦¬ ì„ íƒëœ íšŒì›\n }\n \n const CourseRegistrationModal: React.FC<CourseRegistrationModalProps> = ({\n   isOpen,\n   onClose,\n-  onSuccess\n+  onSuccess,\n+  preselectedMember = null\n }) => {\n   const [selectedMember, setSelectedMember] = useState<Member | null>(null);\n   const [memberPointBalance, setMemberPointBalance] = useState<number>(0);\n   const [paymentInfo, setPaymentInfo] = useState<PaymentInfo>({\n@@ -117,8 +119,15 @@\n     pointPayment: 0\n   });\n   const [isProcessing, setIsProcessing] = useState(false);\n \n+  // ë¯¸ë¦¬ ì„ íƒëœ íšŒì›ì´ ìˆìœ¼ë©´ ì„¤ì •í•˜ê³  í¬ì¸íŠ¸ ì”ì•¡ ë¡œë“œ\n+  useEffect(() => {\n+    if (preselectedMember && isOpen) {\n+      handleMemberSelect(preselectedMember);\n+    }\n+  }, [preselectedMember, isOpen]);\n+\n   // íšŒì› ì„ íƒ ì‹œ í¬ì¸íŠ¸ ì”ì•¡ ë¡œë“œ\n   const handleMemberSelect = async (member: Member) => {\n     setSelectedMember(member);\n     try {\n@@ -235,10 +244,13 @@\n   // ëª¨ë‹¬ ë‹«ê¸° ì²˜ë¦¬\n   const handleClose = () => {\n     if (isProcessing) return;\n     \n-    setSelectedMember(null);\n-    setMemberPointBalance(0);\n+    // ë¯¸ë¦¬ ì„ íƒëœ íšŒì›ì´ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì´ˆê¸°í™”\n+    if (!preselectedMember) {\n+      setSelectedMember(null);\n+      setMemberPointBalance(0);\n+    }\n     setPaymentInfo({\n       selectedProducts: [],\n       paymentMethod: 'card',\n       receivedAmount: 0,\n@@ -260,8 +272,10 @@\n             <MemberSearchPanel\n               selectedMember={selectedMember}\n               onMemberSelect={handleMemberSelect}\n               memberPointBalance={memberPointBalance}\n+              preselectedMember={preselectedMember}\n+              readonly={!!preselectedMember}\n             />\n           </LeftPanel>\n           \n           <RightPanel>\n"
                },
                {
                    "date": 1761459688972,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -85,10 +85,22 @@\n \n interface Product {\n   id: string;\n   name: string;\n-  price: number;\n+  originalPrice?: number; // DBì—ì„œ ê°€ì ¸ì˜¨ ê¸°ë³¸ ê°€ê²©\n+  basePrice?: number; // ê¸°ì¤€ ê°€ê²©\n+  price: number; // ìƒí’ˆê¸ˆì•¡ (ê³„ì‚°ë  ì •í™•í•œ ê¸ˆì•¡)\n+  appliedPrice?: number; // ì ìš©ê¸ˆì•¡ (ì‚¬ìš©ìê°€ ì¡°ì •í•  ìˆ˜ ìˆëŠ” ìµœì¢… ê¸ˆì•¡)\n   description?: string;\n+  programType?: string; // 'ê¸°ê°„ì œ' | 'íšŸìˆ˜ì œ'\n+  // ê¸°ê°„ì œ ê´€ë ¨\n+  duration?: number; // ê¸°ê°„(ì¼)\n+  baseDuration?: number; // ê¸°ì¤€ ê¸°ê°„\n+  startDate?: Date;\n+  endDate?: Date;\n+  // íšŸìˆ˜ì œ ê´€ë ¨\n+  sessions?: number; // ìˆ˜ì—… íšŸìˆ˜\n+  baseSessions?: number; // ê¸°ì¤€ íšŸìˆ˜\n }\n \n interface PaymentInfo {\n   selectedProducts: Product[];\n@@ -158,9 +170,10 @@\n \n     setIsProcessing(true);\n \n     try {\n-      const totalAmount = paymentInfo.selectedProducts.reduce((sum, product) => sum + product.price, 0);\n+      const totalAmount = paymentInfo.selectedProducts.reduce((sum, product) => \n+        sum + (product.appliedPrice || product.price), 0);\n       const pointPayment = paymentInfo.pointPayment || 0;\n       const cashPayment = paymentInfo.receivedAmount || 0; // í˜„ê¸ˆ/ì¹´ë“œë¡œ ë°›ì€ ê¸ˆì•¡\n       const totalReceived = pointPayment + cashPayment; // ì´ ë°›ì€ ê¸ˆì•¡\n \n@@ -200,9 +213,9 @@\n         \n         orderProducts.push({\n           id: product.id,\n           name: product.name,\n-          price: product.price,\n+          price: product.appliedPrice || product.price, // ì ìš©ê¸ˆì•¡ ì‚¬ìš©\n           programId: dbProduct.programId,\n           programName: dbProduct.programName,\n           programType: dbProduct.programType\n         });\n"
                },
                {
                    "date": 1761910063251,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -94,8 +94,10 @@\n   programType?: string; // 'ê¸°ê°„ì œ' | 'íšŸìˆ˜ì œ'\n   // ê¸°ê°„ì œ ê´€ë ¨\n   duration?: number; // ê¸°ê°„(ì¼)\n   baseDuration?: number; // ê¸°ì¤€ ê¸°ê°„\n+  months?: number; // ê°œì›”ìˆ˜\n+  baseMonths?: number; // ê¸°ì¤€ ê°œì›”ìˆ˜\n   startDate?: Date;\n   endDate?: Date;\n   // íšŸìˆ˜ì œ ê´€ë ¨\n   sessions?: number; // ìˆ˜ì—… íšŸìˆ˜\n"
                }
            ],
            "date": 1761132526034,
            "name": "Commit-0",
            "content": "import React, { useState } from 'react';\nimport styled from 'styled-components';\nimport { toast } from 'react-toastify';\nimport Modal from '../../../components/Modal';\nimport { dbManager, type Member } from '../../../utils/indexedDB';\nimport { AppColors } from '../../../styles/colors';\nimport { AppTextStyles } from '../../../styles/textStyles';\nimport MemberSearchPanel from './MemberSearchPanel';\nimport CoursePaymentPanel from './CoursePaymentPanel';\n\nconst ModalContainer = styled.div`\n  display: flex;\n  gap: 24px;\n  height: 600px;\n  min-width: 900px;\n`;\n\nconst LeftPanel = styled.div`\n  flex: 1;\n  border-right: 1px solid ${AppColors.borderLight};\n  padding-right: 24px;\n`;\n\nconst RightPanel = styled.div`\n  flex: 1;\n  padding-left: 24px;\n`;\n\nconst PanelTitle = styled.h3`\n  font-size: ${AppTextStyles.title3.fontSize};\n  font-weight: 700;\n  margin-bottom: 16px;\n  color: ${AppColors.onBackground};\n  border-bottom: 2px solid ${AppColors.primary};\n  padding-bottom: 8px;\n`;\n\nconst Button = styled.button<{ variant?: 'primary' | 'secondary' }>`\n  padding: 12px 24px;\n  border: ${props => props.variant === 'secondary' ? `1px solid ${AppColors.borderLight}` : 'none'};\n  border-radius: 8px;\n  background: ${props => props.variant === 'secondary' ? AppColors.surface : AppColors.primary};\n  color: ${props => props.variant === 'secondary' ? AppColors.onSurface : AppColors.onPrimary};\n  font-size: ${AppTextStyles.body1.fontSize};\n  font-weight: 600;\n  cursor: pointer;\n  transition: all 0.2s;\n  \n  &:hover {\n    opacity: 0.9;\n    transform: translateY(-1px);\n  }\n  \n  &:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n    transform: none;\n  }\n`;\n\nconst ButtonGroup = styled.div`\n  display: flex;\n  justify-content: flex-end;\n  gap: 12px;\n  margin-top: 24px;\n  padding-top: 24px;\n  border-top: 1px solid ${AppColors.borderLight};\n`;\n\nconst WarningText = styled.div`\n  background: #fff3cd;\n  border: 1px solid #ffeaa7;\n  border-radius: 8px;\n  padding: 12px;\n  margin: 16px 0;\n  color: #856404;\n  font-size: 14px;\n  text-align: center;\n`;\n\ninterface Product {\n  id: string;\n  name: string;\n  price: number;\n  description?: string;\n}\n\ninterface PaymentInfo {\n  selectedProducts: Product[];\n  paymentMethod: string;\n  receivedAmount?: number;\n  pointPayment?: number; // í¬ì¸íŠ¸ë¡œ ê²°ì œí•  ê¸ˆì•¡\n}\n\ninterface CourseRegistrationModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onSuccess: () => void;\n}\n\nconst CourseRegistrationModal: React.FC<CourseRegistrationModalProps> = ({\n  isOpen,\n  onClose,\n  onSuccess\n}) => {\n  const [selectedMember, setSelectedMember] = useState<Member | null>(null);\n  const [memberPointBalance, setMemberPointBalance] = useState<number>(0);\n  const [paymentInfo, setPaymentInfo] = useState<PaymentInfo>({\n    selectedProducts: [],\n    paymentMethod: 'card',\n    receivedAmount: 0,\n    pointPayment: 0\n  });\n  const [isProcessing, setIsProcessing] = useState(false);\n\n  // íšŒì› ì„ íƒ ì‹œ í¬ì¸íŠ¸ ì”ì•¡ ë¡œë“œ\n  const handleMemberSelect = async (member: Member) => {\n    setSelectedMember(member);\n    try {\n      const pointBalance = await dbManager.getMemberPointBalance(member.id);\n      setMemberPointBalance(pointBalance);\n    } catch (error) {\n      console.error('í¬ì¸íŠ¸ ì”ì•¡ ì¡°íšŒ ì‹¤íŒ¨:', error);\n      setMemberPointBalance(0);\n    }\n  };\n\n  // ê²°ì œ ì •ë³´ ì—…ë°ì´íŠ¸\n  const handlePaymentUpdate = (updates: Partial<PaymentInfo>) => {\n    setPaymentInfo(prev => ({ ...prev, ...updates }));\n  };\n\n  // ìˆ˜ê°• ë“±ë¡ ì²˜ë¦¬\n  const handleRegisterCourse = async () => {\n    if (!selectedMember) {\n      toast.error('íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');\n      return;\n    }\n\n    if (paymentInfo.selectedProducts.length === 0) {\n      toast.error('ë“±ë¡í•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');\n      return;\n    }\n\n    setIsProcessing(true);\n\n    try {\n      const totalAmount = paymentInfo.selectedProducts.reduce((sum, product) => sum + product.price, 0);\n      const pointPayment = paymentInfo.pointPayment || 0;\n      const cashPayment = (paymentInfo.receivedAmount || 0) - pointPayment;\n      const unpaidAmount = Math.max(0, totalAmount - pointPayment - cashPayment);\n\n      // í¬ì¸íŠ¸ ê²°ì œê°€ ì”ì•¡ì„ ì´ˆê³¼í•˜ëŠ”ì§€ í™•ì¸\n      if (pointPayment > memberPointBalance) {\n        toast.error(`í¬ì¸íŠ¸ ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (ì”ì•¡: ${memberPointBalance.toLocaleString()}ì›)`);\n        return;\n      }\n\n      // ê° ìƒí’ˆë³„ë¡œ ìˆ˜ê°• ë“±ë¡ ë° ê²°ì œ ì²˜ë¦¬\n      for (const product of paymentInfo.selectedProducts) {\n        // 1. ìƒí’ˆ ì •ë³´ ì¡°íšŒ (í”„ë¡œê·¸ë¨ ì •ë³´ í¬í•¨)\n        const dbProduct = await dbManager.getProductById(product.id);\n        if (!dbProduct) {\n          throw new Error(`ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${product.name}`);\n        }\n\n        // 2. ìˆ˜ê°• ë“±ë¡ ë°ì´í„° ìƒì„±\n        const courseData = {\n          memberId: selectedMember.id,\n          memberName: selectedMember.name,\n          productId: product.id,\n          productName: product.name,\n          productPrice: product.price,\n          programId: dbProduct.programId,\n          programName: dbProduct.programName,\n          programType: dbProduct.programType,\n          branchId: selectedMember.branchId,\n          branchName: selectedMember.branchName,\n          coach: selectedMember.coach,\n          coachName: selectedMember.coachName,\n          enrollmentStatus: unpaidAmount > 0 ? 'unpaid' as const : 'completed' as const,\n          paidAmount: Math.min(product.price, pointPayment + cashPayment),\n          unpaidAmount: Math.max(0, product.price - pointPayment - cashPayment),\n          startDate: new Date(),\n          endDate: dbProduct.programType === 'ê¸°ê°„ì œ' ? (() => {\n            const endDate = new Date();\n            endDate.setMonth(endDate.getMonth() + 3); // ê¸°ë³¸ 3ê°œì›”\n            return endDate;\n          })() : undefined,\n          sessionCount: dbProduct.sessions || undefined,\n          completedSessions: 0,\n          notes: 'ìƒˆ ìˆ˜ê°• ë“±ë¡ì„ í†µí•´ ë“±ë¡ë¨'\n        };\n\n        // 3. ìˆ˜ê°• ë“±ë¡ ì €ì¥\n        const courseId = await dbManager.addCourseEnrollment(courseData);\n\n        // 4. ê²°ì œ ë°ì´í„° ìƒì„±\n        const paymentData = {\n          memberId: selectedMember.id,\n          memberName: selectedMember.name,\n          branchId: selectedMember.branchId,\n          branchName: selectedMember.branchName,\n          coach: selectedMember.coach,\n          coachName: selectedMember.coachName,\n          paymentMethod: paymentInfo.paymentMethod,\n          paymentStatus: unpaidAmount > 0 ? 'unpaid' as const : 'completed' as const,\n          totalAmount: product.price,\n          paidAmount: Math.min(product.price, pointPayment + cashPayment),\n          unpaidAmount: Math.max(0, product.price - pointPayment - cashPayment),\n          paymentDate: new Date(),\n          paymentType: 'course' as const,\n          relatedCourseId: courseId,\n          relatedAssetId: null,\n          products: [{\n            id: product.id,\n            name: product.name,\n            price: product.price,\n            quantity: 1,\n            programId: dbProduct.programId,\n            programName: dbProduct.programName,\n            programType: dbProduct.programType\n          }],\n          memo: `ìƒˆ ìˆ˜ê°• ë“±ë¡ - ${product.name} (ìˆ˜ê°• ID: ${courseId})`\n        };\n\n        // 5. ê²°ì œ ì •ë³´ ì €ì¥\n        await dbManager.addPayment(paymentData);\n      }\n\n      // 6. í¬ì¸íŠ¸ ì‚¬ìš© ì²˜ë¦¬\n      if (pointPayment > 0) {\n        await dbManager.addPoint({\n          memberId: selectedMember.id,\n          memberName: selectedMember.name,\n          amount: -pointPayment, // ìŒìˆ˜ë¡œ ì €ì¥ (ì‚¬ìš©)\n          type: 'used',\n          source: 'ìˆ˜ê°•ë“±ë¡ í¬ì¸íŠ¸ê²°ì œ',\n          description: `ìˆ˜ê°•ë“±ë¡ í¬ì¸íŠ¸ ê²°ì œ (${paymentInfo.selectedProducts.map(p => p.name).join(', ')})`\n        });\n      }\n\n      // 7. ì´ˆê³¼ ê¸ˆì•¡ í¬ì¸íŠ¸ ì ë¦½ ì²˜ë¦¬\n      if (cashPayment > totalAmount - pointPayment) {\n        const excessAmount = cashPayment - (totalAmount - pointPayment);\n        await dbManager.addPoint({\n          memberId: selectedMember.id,\n          memberName: selectedMember.name,\n          amount: excessAmount,\n          type: 'earned',\n          source: 'ìˆ˜ê°•ë“±ë¡ ì´ˆê³¼ê¸ˆì•¡',\n          description: `ìˆ˜ê°•ë“±ë¡ ì´ˆê³¼ê¸ˆì•¡ í¬ì¸íŠ¸ ì ë¦½ (${excessAmount.toLocaleString()}ì›)`\n        });\n      }\n\n      toast.success('ìˆ˜ê°• ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');\n      onSuccess();\n      onClose();\n    } catch (error) {\n      console.error('ìˆ˜ê°• ë“±ë¡ ì‹¤íŒ¨:', error);\n      toast.error('ìˆ˜ê°• ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  // ëª¨ë‹¬ ë‹«ê¸° ì²˜ë¦¬\n  const handleClose = () => {\n    if (isProcessing) return;\n    \n    setSelectedMember(null);\n    setMemberPointBalance(0);\n    setPaymentInfo({\n      selectedProducts: [],\n      paymentMethod: 'card',\n      receivedAmount: 0,\n      pointPayment: 0\n    });\n    onClose();\n  };\n\n  return (\n    <Modal\n      isOpen={isOpen}\n      onClose={handleClose}\n      width=\"min(95vw, 1000px)\"\n      header=\"ìƒˆ ìˆ˜ê°• ë“±ë¡\"\n      body={\n        <ModalContainer>\n          <LeftPanel>\n            <PanelTitle>íšŒì› ê²€ìƒ‰ ë° ì„ íƒ</PanelTitle>\n            <MemberSearchPanel\n              selectedMember={selectedMember}\n              onMemberSelect={handleMemberSelect}\n              memberPointBalance={memberPointBalance}\n            />\n          </LeftPanel>\n          \n          <RightPanel>\n            <PanelTitle>ê²°ì œ ì •ë³´</PanelTitle>\n            {!selectedMember ? (\n              <WarningText>\n                ë¨¼ì € ì™¼ìª½ì—ì„œ íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.\n              </WarningText>\n            ) : (\n              <CoursePaymentPanel\n                selectedMember={selectedMember}\n                memberPointBalance={memberPointBalance}\n                paymentInfo={paymentInfo}\n                onPaymentUpdate={handlePaymentUpdate}\n              />\n            )}\n          </RightPanel>\n        </ModalContainer>\n      }\n      footer={\n        <ButtonGroup>\n          <Button variant=\"secondary\" onClick={handleClose} disabled={isProcessing}>\n            ì·¨ì†Œ\n          </Button>\n          <Button \n            onClick={handleRegisterCourse} \n            disabled={isProcessing || !selectedMember || paymentInfo.selectedProducts.length === 0}\n          >\n            {isProcessing ? 'ë“±ë¡ ì¤‘...' : 'ìˆ˜ê°• ë“±ë¡'}\n          </Button>\n        </ButtonGroup>\n      }\n    />\n  );\n};\n\nexport default CourseRegistrationModal;"
        }
    ]
}