{
    "sourceFile": "src/utils/db/ReservationHelper.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763984635964,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763984635964,
            "name": "Commit-0",
            "content": "/**\n * 예약/수강권 관련 헬퍼 함수 (이벤트 소싱 방식)\n */\n\nimport { dbManager } from './index';\nimport type { CourseEnrollment, ScheduleEvent } from './types';\n\n/**\n * 수강권의 완료된 세션 수 계산 (이벤트 소싱)\n * ScheduleEvent 테이블에서 해당 수강권의 active/completed 상태 예약을 집계\n */\nexport async function getCompletedSessions(enrollmentId: string): Promise<number> {\n  try {\n    // 모든 예약 이벤트 조회\n    const allEvents = await dbManager.getAllScheduleEvents();\n    \n    // 해당 수강권의 완료된 예약만 필터링\n    const completedEvents = allEvents.filter(event => \n      event.enrollmentId === enrollmentId &&\n      event.type === 'class' && // 일반 예약만 (상담/기타 제외)\n      (event.status === 'active' || event.status === 'completed') // 취소/노쇼 제외\n    );\n    \n    return completedEvents.length;\n  } catch (error) {\n    console.error('완료 세션 계산 실패:', error);\n    return 0;\n  }\n}\n\n/**\n * 수강권의 남은 횟수 계산 (이벤트 소싱)\n */\nexport async function getRemainingSessionsCount(enrollment: CourseEnrollment): Promise<number> {\n  if (enrollment.programType !== '횟수제' || !enrollment.sessionCount) {\n    return 0;\n  }\n  \n  const completedSessions = await getCompletedSessions(enrollment.id);\n  const remaining = (enrollment.sessionCount || 0) - completedSessions;\n  \n  return Math.max(0, remaining); // 음수 방지\n}\n\n/**\n * 회원의 모든 수강권에 대한 남은 횟수 정보 조회 (확장)\n */\nexport interface EnrollmentWithSessions extends CourseEnrollment {\n  completedSessions: number;\n  remainingSessions: number;\n}\n\nexport async function getMemberEnrollmentsWithSessions(memberId: string): Promise<EnrollmentWithSessions[]> {\n  try {\n    const enrollments = await dbManager.getCourseEnrollmentsByMember(memberId);\n    \n    const enrollmentsWithSessions: EnrollmentWithSessions[] = [];\n    \n    for (const enrollment of enrollments) {\n      const completedSessions = await getCompletedSessions(enrollment.id);\n      const remainingSessions = (enrollment.sessionCount || 0) - completedSessions;\n      \n      enrollmentsWithSessions.push({\n        ...enrollment,\n        completedSessions,\n        remainingSessions: Math.max(0, remainingSessions)\n      });\n    }\n    \n    return enrollmentsWithSessions;\n  } catch (error) {\n    console.error('회원 수강권 조회 실패:', error);\n    return [];\n  }\n}\n\n/**\n * 수강권의 예약 히스토리 조회\n */\nexport async function getEnrollmentReservationHistory(enrollmentId: string): Promise<ScheduleEvent[]> {\n  try {\n    const allEvents = await dbManager.getAllScheduleEvents();\n    \n    return allEvents.filter(event =>\n      event.enrollmentId === enrollmentId &&\n      event.type === 'class'\n    ).sort((a, b) => new Date(b.startTime).getTime() - new Date(a.startTime).getTime());\n  } catch (error) {\n    console.error('예약 히스토리 조회 실패:', error);\n    return [];\n  }\n}\n\n/**\n * 예약 통계 조회\n */\nexport interface ReservationStats {\n  total: number;\n  active: number;\n  completed: number;\n  cancelled: number;\n  noshow: number;\n}\n\nexport async function getEnrollmentReservationStats(enrollmentId: string): Promise<ReservationStats> {\n  try {\n    const history = await getEnrollmentReservationHistory(enrollmentId);\n    \n    return {\n      total: history.length,\n      active: history.filter(e => e.status === 'active').length,\n      completed: history.filter(e => e.status === 'completed').length,\n      cancelled: history.filter(e => e.status === 'cancelled').length,\n      noshow: history.filter(e => e.status === 'noshow').length\n    };\n  } catch (error) {\n    console.error('예약 통계 조회 실패:', error);\n    return { total: 0, active: 0, completed: 0, cancelled: 0, noshow: 0 };\n  }\n}\n"
        }
    ]
}