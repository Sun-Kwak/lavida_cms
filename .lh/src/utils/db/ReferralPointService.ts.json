{
    "sourceFile": "src/utils/db/ReferralPointService.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1763550103659,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763550639236,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -132,15 +132,23 @@\n   }\n \n   /**\n    * 지점별 추천 포인트 가져오기 (활성화된 설정만)\n+   * 해당 지점 설정이 없으면 \"전체\" 지점 설정을 사용\n    * @param branchId 지점 ID\n    * @returns {referrerPoints, referredPoints} 또는 기본값 {0, 0}\n    */\n   async getReferralPoints(branchId: string): Promise<{ referrerPoints: number; referredPoints: number }> {\n     try {\n-      const settings = await this.getReferralPointSettingsByBranchId(branchId);\n+      // 1. 해당 지점의 설정 확인\n+      let settings = await this.getReferralPointSettingsByBranchId(branchId);\n       \n+      // 2. 해당 지점 설정이 없으면 \"전체\" 지점 설정 사용\n+      if (!settings) {\n+        const allSettings = await this.getAllReferralPointSettings();\n+        settings = allSettings.find(s => s.branchName === '전체') || null;\n+      }\n+      \n       if (settings && settings.isActive) {\n         return {\n           referrerPoints: settings.referrerPoints,\n           referredPoints: settings.referredPoints,\n"
                }
            ],
            "date": 1763550103659,
            "name": "Commit-0",
            "content": "/**\n * 추천 포인트 설정 관리 서비스\n */\n\nimport { BaseDBManager } from './BaseDBManager';\nimport { ReferralPointSettings } from './types';\n\nexport class ReferralPointService extends BaseDBManager {\n  \n  /**\n   * 모든 추천 포인트 설정 조회\n   */\n  async getAllReferralPointSettings(): Promise<ReferralPointSettings[]> {\n    try {\n      return await this.executeTransaction('referralPointSettings', 'readonly', (store) => \n        store.getAll()\n      );\n    } catch (error) {\n      console.error('추천 포인트 설정 조회 실패:', error);\n      return [];\n    }\n  }\n\n  /**\n   * 지점 ID로 추천 포인트 설정 조회\n   */\n  async getReferralPointSettingsByBranchId(branchId: string): Promise<ReferralPointSettings | null> {\n    try {\n      const allSettings = await this.getAllReferralPointSettings();\n      const setting = allSettings.find(s => s.branchId === branchId);\n      return setting || null;\n    } catch (error) {\n      console.error('추천 포인트 설정 조회 실패:', error);\n      return null;\n    }\n  }\n\n  /**\n   * ID로 추천 포인트 설정 조회\n   */\n  async getReferralPointSettingsById(id: string): Promise<ReferralPointSettings | null> {\n    try {\n      const result = await this.executeTransaction('referralPointSettings', 'readonly', (store) => \n        store.get(id)\n      );\n      return result || null;\n    } catch (error) {\n      console.error('추천 포인트 설정 조회 실패:', error);\n      return null;\n    }\n  }\n\n  /**\n   * 추천 포인트 설정 추가\n   */\n  async addReferralPointSettings(\n    settingsData: Omit<ReferralPointSettings, 'id' | 'createdAt' | 'updatedAt'>\n  ): Promise<ReferralPointSettings> {\n    const now = new Date();\n    \n    // 해당 지점에 이미 설정이 있는지 확인\n    const existing = await this.getReferralPointSettingsByBranchId(settingsData.branchId);\n    if (existing) {\n      throw new Error('해당 지점의 추천 포인트 설정이 이미 존재합니다.');\n    }\n\n    const newSettings: ReferralPointSettings = {\n      ...settingsData,\n      id: this.generateUUID(),\n      createdAt: now,\n      updatedAt: now,\n    };\n\n    try {\n      await this.executeTransaction('referralPointSettings', 'readwrite', (store) => \n        store.add(newSettings)\n      );\n      console.log('추천 포인트 설정 추가 성공:', newSettings);\n      return newSettings;\n    } catch (error) {\n      console.error('추천 포인트 설정 추가 실패:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * 추천 포인트 설정 수정\n   */\n  async updateReferralPointSettings(\n    id: string, \n    updates: Partial<Omit<ReferralPointSettings, 'id' | 'createdAt' | 'branchId'>>\n  ): Promise<ReferralPointSettings | null> {\n    try {\n      const existing = await this.getReferralPointSettingsById(id);\n      if (!existing) {\n        throw new Error('존재하지 않는 추천 포인트 설정입니다.');\n      }\n\n      const updatedSettings: ReferralPointSettings = {\n        ...existing,\n        ...updates,\n        updatedAt: new Date(),\n      };\n\n      await this.executeTransaction('referralPointSettings', 'readwrite', (store) => \n        store.put(updatedSettings)\n      );\n      \n      console.log('추천 포인트 설정 수정 성공:', updatedSettings);\n      return updatedSettings;\n    } catch (error) {\n      console.error('추천 포인트 설정 수정 실패:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * 추천 포인트 설정 삭제\n   */\n  async deleteReferralPointSettings(id: string): Promise<boolean> {\n    try {\n      await this.executeTransaction('referralPointSettings', 'readwrite', (store) => \n        store.delete(id)\n      );\n      \n      console.log('추천 포인트 설정 삭제 성공:', id);\n      return true;\n    } catch (error) {\n      console.error('추천 포인트 설정 삭제 실패:', error);\n      return false;\n    }\n  }\n\n  /**\n   * 지점별 추천 포인트 가져오기 (활성화된 설정만)\n   * @param branchId 지점 ID\n   * @returns {referrerPoints, referredPoints} 또는 기본값 {0, 0}\n   */\n  async getReferralPoints(branchId: string): Promise<{ referrerPoints: number; referredPoints: number }> {\n    try {\n      const settings = await this.getReferralPointSettingsByBranchId(branchId);\n      \n      if (settings && settings.isActive) {\n        return {\n          referrerPoints: settings.referrerPoints,\n          referredPoints: settings.referredPoints,\n        };\n      }\n      \n      // 설정이 없거나 비활성화된 경우 기본값 반환\n      return {\n        referrerPoints: 0,\n        referredPoints: 0,\n      };\n    } catch (error) {\n      console.error('추천 포인트 조회 실패:', error);\n      return {\n        referrerPoints: 0,\n        referredPoints: 0,\n      };\n    }\n  }\n}\n"
        }
    ]
}